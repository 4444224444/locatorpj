<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>위치추적</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .panel {
      position: absolute; z-index: 1000; top: 12px; left: 12px;
      background: rgba(255,255,255,.92); backdrop-filter: blur(6px);
      border-radius: 12px; padding: 10px 12px; box-shadow: 0 6px 16px rgba(0,0,0,.12);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    }
    .panel b { display: inline-block; min-width: 6.5em; }
    .row { margin: 4px 0; }
    .btn {
      display: inline-block; margin-top: 6px; padding: 6px 10px; border-radius: 10px;
      border: 1px solid #ddd; background: #fff; cursor: pointer;
    }
    .warn {
      position: absolute; z-index: 1000; bottom: 12px; left: 50%; transform: translateX(-50%);
      background: #ffefc7; color: #7a5200; border: 1px solid #f1d27a; border-radius: 10px;
      padding: 8px 12px; box-shadow: 0 4px 12px rgba(0,0,0,.1); max-width: 92%;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    }

    /* 펄싱 위치 점 */
    .pulse {
      width: 14px; height: 14px; border-radius: 50%;
      background: #2d7ef7; box-shadow: 0 0 0 rgba(45,126,247,0.4);
      animation: pulse 2s infinite;
      border: 2px solid #fff;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(45,126,247,0.5); }
      70%  { box-shadow: 0 0 0 16px rgba(45,126,247,0); }
      100% { box-shadow: 0 0 0 0 rgba(45,126,247,0); }
    }

    /* Leaflet divIcon용 래퍼 */
    .dot {
      display: grid; place-items: center;
      width: 24px; height: 24px; margin-left: -12px; margin-top: -12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="panel">
    <div class="row"><b>상태</b><span id="status">초기화 중…</span></div>
    <div class="row"><b>정확도</b><span id="acc">-</span></div>
    <div class="row"><b>좌표</b><span id="coords">-</span></div>
    <div class="row"><b>업데이트</b><span id="ts">-</span></div>
    <button class="btn" id="toggleFollow">따라가기: 켬</button>
    <button class="btn" id="openMaps">구글맵</button>
    <button class="btn" id="stopWatch">추적 끄기</button>
  </div>

  <div class="warn" id="httpsWarn" style="display:none">
    위치 기능은 HTTPS에서만 동작한다. 배포 시 반드시 https 도메인(또는 개발 중에는 localhost)을 사용한다.
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // HTTPS 경고
    (function(){
      const isHttps = location.protocol === 'https:' || location.hostname === 'localhost';
      if (!isHttps) document.getElementById('httpsWarn').style.display = 'block';
    })();

    // 지도 기본 설정
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // UI 엘리먼트
    const $status = document.getElementById('status');
    const $acc    = document.getElementById('acc');
    const $coords = document.getElementById('coords');
    const $ts     = document.getElementById('ts');
    const $open   = document.getElementById('openMaps');
    const $stop   = document.getElementById('stopWatch');
    const $followBtn = document.getElementById('toggleFollow');

    function fmt(n) { return typeof n === 'number' ? n.toFixed(6) : n; }
    function stamp() {
      const d = new Date();
      const pad = (n) => n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // 상태 변수
    let watchId = null;
    let followMode = true;          // 자동 따라가기
    let accuracyCircle = null;
    let pathLine = L.polyline([], { color: '#2d7ef7', weight: 4, opacity: 0.6 }).addTo(map);

    // 펄싱 점(부드러운 이동용)
    const dotIcon = L.divIcon({
      className: 'dot',
      html: '<div class="pulse"></div>',
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });
    const dot = L.marker([0,0], { icon: dotIcon, zIndexOffset: 1000 }).addTo(map);

    // 부드러운 이동(보간)
    let lastPos = null;     // {lat, lng}
    let targetPos = null;   // {lat, lng}
    let animStart = 0;
    const DURATION = 600;   // ms (GPS 갱신 간의 애니메이션 길이)
    function lerp(a, b, t) { return a + (b - a) * t; }
    function animate() {
      if (!lastPos || !targetPos) return;
      const now = performance.now();
      const t = Math.min(1, (now - animStart) / DURATION);
      const lat = lerp(lastPos.lat, targetPos.lat, t);
      const lng = lerp(lastPos.lng, targetPos.lng, t);
      dot.setLatLng([lat, lng]);
      if (followMode) map.panTo([lat, lng], { animate: false });

      if (t < 1) {
        requestAnimationFrame(animate);
      } else {
        lastPos = targetPos; // 도달
      }
    }

    function moveDotSmooth(next) {
      if (!lastPos) {
        lastPos = next;
        dot.setLatLng([next.lat, next.lng]);
        map.setView([next.lat, next.lng], 17);
        return;
      }
      targetPos = next;
      animStart = performance.now();
      requestAnimationFrame(animate);
    }

    // UI 업데이트
    function updateUI({lat, lng, accuracy}) {
      $status.textContent = '위치 수신 중';
      $acc.textContent    = isFinite(accuracy) ? `${Math.round(accuracy)} m` : '-';
      $coords.textContent = `${fmt(lat)}, ${fmt(lng)}`;
      $ts.textContent     = stamp();
      $open.onclick = () => window.open(`https://maps.google.com/?q=${lat},${lng}`, '_blank', 'noopener');
    }

    // 지도 요소 업데이트
    function updateMap({lat, lng, accuracy}) {
      // 점 부드럽게 이동
      moveDotSmooth({ lat, lng });

      // 정확도 원
      if (!accuracyCircle) {
        accuracyCircle = L.circle([lat, lng], {
          radius: isFinite(accuracy) ? accuracy : 50,
          color: '#136aec', fillColor: '#136aec', fillOpacity: 0.12, weight: 2
        }).addTo(map);
      } else {
        accuracyCircle.setLatLng([lat, lng]);
        if (isFinite(accuracy)) accuracyCircle.setRadius(accuracy);
      }

      // 경로(최근 500개 좌표만 유지)
      const pts = pathLine.getLatLngs();
      pts.push([lat, lng]);
      if (pts.length > 500) pts.shift();
      pathLine.setLatLngs(pts);
    }

    // 위치 성공/실패 콜백
    function onPosSuccess(position) {
      const { latitude: lat, longitude: lng, accuracy } = position.coords;
      updateUI({lat, lng, accuracy});
      updateMap({lat, lng, accuracy});
    }
    function onPosError(err) {
      console.warn(err);
      $status.textContent = `오류: ${err.message}`;
    }

    // 위치 추적 시작
    function startWatch() {
      if (!('geolocation' in navigator)) {
        $status.textContent = '이 기기에서 위치 기능을 지원하지 않는다';
        return;
      }
      $status.textContent = '권한 요청 중…';
      watchId = navigator.geolocation.watchPosition(onPosSuccess, onPosError, {
        enableHighAccuracy: true,
        maximumAge: 3000,
        timeout: 10000
      });
    }

    // 버튼 동작
    $stop.onclick = () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        $status.textContent = '추적 중지됨';
      }
    };
    $followBtn.onclick = () => {
      followMode = !followMode;
      $followBtn.textContent = `따라가기: ${followMode ? '켬' : '끔'}`;
      if (followMode && lastPos) map.panTo([lastPos.lat, lastPos.lng]);
    };

    // 시작
    startWatch();
  </script>
</body>
</html>
